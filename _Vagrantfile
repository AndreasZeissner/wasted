# -*- mode: ruby -*-
# vi: set ft=ruby :

$ip = '192.168.56.112'
$hostname = 'app-name.dev'
$synced_folder = '/var/www/app_name'

if Vagrant.has_plugin?('vagrant-vbguest')
  class GuestAdditionsFixer < VagrantVbguest::Installers::Ubuntu
    def install(opts=nil, &block)
      super
      communicate.sudo('([ -e /opt/VBoxGuestAdditions-4.3.10 ] && sudo ln -s /opt/VBoxGuestAdditions-4.3.10/lib/VBoxGuestAdditions /usr/lib/VBoxGuestAdditions) || true')
    end
  end
end

provider   = (ENV['VAGRANT_DEFAULT_PROVIDER'] || :virtualbox).to_sym

configfile = File.expand_path('../../vagrant_project_config', __FILE__)
load configfile if File.exist?(configfile)
personal_configfile = File.expand_path('../../vagrant_personal_config', __FILE__)
load personal_configfile if File.exist?(personal_configfile)

Vagrant.configure("2") do |config|
  if Vagrant.has_plugin?("vagrant-vbguest")
    config.vbguest.installer = GuestAdditionsFixer
  end

  config.vm.box = "trusty64"
  config.vm.hostname = $hostname

  # Use vagrant-hostmanager if installed
  if Vagrant.has_plugin?('vagrant-hostmanager')
    config.hostmanager.enabled = true
    config.hostmanager.manage_host = true
    config.hostmanager.include_offline = true
  end

  if Vagrant.has_plugin?('vagrant-vbguest')
    config.vbguest.installer = GuestAdditionsFixer
  end

  if provider == :virtualbox
    config.vm.box_url = 'http://filedump.mayflower.de/baseboxes/ubuntu-14.04-puppet3.4.3-vbox4.3.10.box'
  elsif provider == :lxc
    config.vm.box_url = 'http://filedump.mayflower.de/baseboxes/ubuntu-14.04-puppet3.4.3-lxc.box'
  else
    puts 'Your Vagrant provider isn\'t supported!'
  end

  config.vm.provider :virtualbox do |vb|
    vb.customize ['modifyvm', :id, '--memory', '2048']
  end

  # Use vagrant-cachier if installed
  if Vagrant.has_plugin?('vagrant-cachier')
    config.cache.auto_detect = true
  end

  # Install r10k using the shell provisioner and download the Puppet modules
  config.vm.provision :shell, :path => 'vagrant/puppet-bootstrap.sh'

  config.vm.synced_folder './', $synced_folder
  config.vm.network :private_network, :ip => $ip

  config.vm.provision :hostmanager if Vagrant.has_plugin?('vagrant-hostmanager')
  config.vm.provision :puppet do |puppet|
    puppet.manifests_path    = 'vagrant/manifests'
    puppet.manifest_file     = 'ubuntu_devstack.pp'
    puppet.module_path       = ['vagrant/modules', 'vagrant/site']
    puppet.options           = '--verbose'
    puppet.hiera_config_path = 'vagrant/hiera.yaml'
  end
end
